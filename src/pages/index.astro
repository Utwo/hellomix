---
import Layout from "../layouts/Layout.astro";
import allPlaylistsJson from "../all-playlists.json";

const playlists = allPlaylistsJson.playlists.sort((a, b) => b.id - a.id);
---

<Layout>
  <ul
    class="playlist m-0 grid grid-cols-[repeat(auto-fill,minmax(250px,1fr))] gap-6 p-0 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))] sm:gap-3 md:grid-cols-[repeat(auto-fill,minmax(180px,1fr))] md:gap-4 xl:grid-cols-[repeat(auto-fill,minmax(220px,1fr))] xl:gap-6"
  >
    {
      playlists.map((playlist, index) => {
        return (
          <li class="rounded-md transition-[translate,box-shadow] duration-300 ease-in-out hover:-translate-y-1 hover:shadow-xl">
            <a href={`/?mix=${playlist.slug}`} title={playlist.name}>
              <div class="relative">
                <img
                  loading={index < 12 ? "eager" : "lazy"}
                  src={`/albums/${playlist.slug}.webp`}
                  width="400"
                  height="400"
                  alt={playlist.name}
                  decoding="async"
                  fetchpriority={index < 12 ? "high" : "low"}
                  class="aspect-square rounded-md object-cover"
                  sizes="(max-width: 480px) 150px, (max-width: 768px) 180px, (max-width: 1200px) 220px, 250px"
                />
                <div
                  class="play-button absolute top-1/2 left-1/2 flex h-13 w-13 origin-center -translate-x-1/2 -translate-y-1/2 items-center justify-center rounded-full bg-white text-black opacity-0 shadow-2xl shadow-gray-900 transition-all duration-300 ease-in-out hover:scale-110 active:scale-95"
                  aria-label={`Play ${playlist.name}`}
                  title={`Play ${playlist.name}`}
                  data-slug={playlist.slug}
                >
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                    class="h-6 w-6"
                  >
                    <path d="M8 5v14l11-7z" />
                  </svg>
                </div>
              </div>
              <span class="block overflow-hidden pb-1 text-ellipsis whitespace-nowrap">
                {playlist.name}
              </span>
            </a>
          </li>
        );
      })
    }
  </ul>

  <!-- Minimal bottom player - always rendered, shown/hidden by JavaScript -->
  <div
    id="pageslide"
    class="fixed right-0 bottom-0 left-0 z-50 h-20 w-full translate-y-full overflow-hidden border-t border-neutral-900/20 bg-neutral-100 p-0 shadow-[0_-2px_12px_rgba(255,255,255,0.1)] transition-transform duration-300 ease-in-out dark:border-neutral-50/10 dark:bg-neutral-900"
  >
    <div
      class="modal-content mx-auto flex h-full max-w-3xl items-center gap-4 overflow-visible px-4 md:px-6"
    >
    </div>
  </div>
</Layout>

<style>
  li:hover .play-button {
    opacity: 1;
    transform: scale(1);
  }
</style>

<!-- Client-side playlist player script -->
<script is:inline src="/js/playlist-player.js"></script>

<script
  is:inline
  define:vars={{
    playlistsData: playlists.map((p) => ({ name: p.name, slug: p.slug })),
  }}
>
  (function () {
    function init() {
      // Handle shuffle functionality
      if (
        new URLSearchParams(window.location.search).has("shuffle") &&
        playlistsData.length > 0
      ) {
        var randomPlaylist =
          playlistsData[Math.floor(Math.random() * playlistsData.length)];
        window.history.pushState(
          {},
          "",
          "/?mix=" + encodeURIComponent(randomPlaylist.slug),
        );
        if (window.checkAndShowModal)
          window.checkAndShowModal(randomPlaylist.slug);
      }

      // Handle shuffle button click - prevent page refresh
      var shuffleLink = document.querySelector('header nav a[href*="shuffle"]');
      if (shuffleLink) {
        shuffleLink.addEventListener("click", function (event) {
          event.preventDefault();
          if (playlistsData.length > 0) {
            var randomPlaylist =
              playlistsData[Math.floor(Math.random() * playlistsData.length)];
            window.history.pushState(
              {},
              "",
              "/?mix=" + encodeURIComponent(randomPlaylist.slug),
            );
            if (window.checkAndShowModal)
              window.checkAndShowModal(randomPlaylist.slug);
          }
        });
      }

      // Handle playlist clicks - prevent page refresh and show modal
      document.querySelectorAll(".playlist li a").forEach(function (link) {
        link.addEventListener("click", function (event) {
          event.preventDefault();
          var href = this.getAttribute("href");
          if (href && href.includes("?mix=")) {
            var mixParam = new URL(
              href,
              window.location.origin,
            ).searchParams.get("mix");
            if (mixParam) {
              window.history.pushState({}, "", href);
              // Pass true to indicate this was user-activated (click event)
              if (window.checkAndShowModal)
                window.checkAndShowModal(mixParam, true);
            }
          }
        });
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>
